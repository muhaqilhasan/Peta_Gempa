<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: sans-serif; }
        #map { width: 100%; height: 100%; background: #f8fafc; }

        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .leaflet-popup-content { margin: 10px; text-align: center; }
        .popup-mag { font-size: 16px; font-weight: bold; color: #0891b2; }
        .popup-date { font-size: 11px; color: #64748b; margin-top: 2px; }
        .popup-loc { font-size: 12px; margin: 4px 0; color: #334155; }
        .btn-detail {
            background: #0f172a; color: white; border: none;
            padding: 6px 12px; border-radius: 6px; font-size: 11px;
            margin-top: 8px; cursor: pointer; width: 100%;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    var map = L.map('map', {zoomControl: false}).setView([-2.5489, 118.0149], 5);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        maxZoom: 20
    }).addTo(map);

    var markers = [];

    function updateMapFromAndroid(jsonString) {
        try {
            var data = JSON.parse(jsonString);

            markers.forEach(function(m) { map.removeLayer(m); });
            markers = [];

            data.forEach(function(gempa, index) {
                var coords = gempa.Coordinates.split(',');
                var lat = parseFloat(coords[0]);
                var lng = parseFloat(coords[1]);
                var mag = parseFloat(gempa.Magnitude);

                var color = '#22c55e';
                if(mag >= 5) color = '#f97316';
                if(mag >= 6) color = '#ef4444';

                var circle = L.circleMarker([lat, lng], {
                    radius: index === 0 ? 12 : 6,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);

                var content = `
                    <div class="popup-mag" style="color:${color}">${gempa.Magnitude} SR</div>
                    <div class="popup-date">${gempa.Tanggal} â€¢ ${gempa.Jam}</div>
                    <div class="popup-loc">${gempa.Wilayah}</div>
                    <button class="btn-detail" onclick="Android.onMarkerClick(${index})">Detail</button>
                `;

                circle.bindPopup(content);
                markers.push(circle);

                // Auto zoom ke gempa terkini saat pertama load
                if(index === 0 && !window.hasFocused) {
                    map.setView([lat, lng], 6);
                    window.hasFocused = true; // prevent auto zoom on refresh unless forced
                }
            });
        } catch(e) {
            console.log("Error parsing JSON: " + e);
        }
    }

    // Fungsi baru untuk fokus kamera dari Android
    function focusToLocation(lat, lng) {
        map.flyTo([lat, lng], 10, {
            animate: true,
            duration: 1.5
        });

        // Mencoba mencari marker terdekat di lokasi tersebut untuk membuka popup
        // (Opsional)
        markers.forEach(function(marker) {
            var mLat = marker.getLatLng().lat;
            var mLng = marker.getLatLng().lng;
            // Cek presisi sederhana
            if(Math.abs(mLat - lat) < 0.001 && Math.abs(mLng - lng) < 0.001) {
                setTimeout(function() { marker.openPopup(); }, 1500); // Buka popup setelah animasi selesai
            }
        });
    }
</script>
</body>
</html>